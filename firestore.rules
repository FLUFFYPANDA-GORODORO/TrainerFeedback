rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============ HELPER FUNCTIONS ============

    // Get the authenticated user's role from the 'users' collection,
    // falling back to 'trainers' collection if not found in 'users'
    function getUserRole() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : (exists(/databases/$(database)/documents/trainers/$(request.auth.uid))
          ? get(/databases/$(database)/documents/trainers/$(request.auth.uid)).data.role
          : null);
    }

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Role checks
    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'superAdmin';
    }

    function isCollegeAdmin() {
      return isAuthenticated() && getUserRole() == 'collegeAdmin';
    }

    function isTrainer() {
      return isAuthenticated() && getUserRole() == 'trainer';
    }

    function isAdminOrAbove() {
      return isAuthenticated() && getUserRole() in ['superAdmin', 'collegeAdmin'];
    }

    function isAnyRole() {
      return isAuthenticated() && getUserRole() in ['superAdmin', 'collegeAdmin', 'trainer'];
    }

    // Get the college ID assigned to the current user
    function getUserCollegeId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.collegeId;
    }

    // ============ USERS COLLECTION ============
    // Document ID = Firebase Auth UID
    // Fields: uid, email, role, name, collegeId, createdAt, updatedAt
    match /users/{userId} {
      // SuperAdmin: full CRUD on all users
      // Any authenticated user: can read their own document (self-read first to avoid circular call)
      allow read: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin() || request.auth.uid == userId;
      allow delete: if isSuperAdmin();
    }

    // ============ TRAINERS COLLECTION ============
    // Document ID = Firebase Auth UID
    // Fields: uid, email, name, trainer_id, domain, specialisation, topics, createdAt
    match /trainers/{trainerId} {
      // Any authenticated user can read their own trainer doc (needed for login)
      // SuperAdmin/CollegeAdmin: read all trainers
      // Trainer: read own + other trainers via isAnyRole
      allow read: if isAuthenticated() && (request.auth.uid == trainerId || isAnyRole());
      allow create, update, delete: if isSuperAdmin();
    }

    // ============ COLLEGES COLLECTION ============
    // Fields: name, code, location, contact, createdAt
    match /colleges/{collegeId} {
      // SuperAdmin: full CRUD
      // CollegeAdmin: read own college only
      // Trainer: read all (needed for session context)
      allow read: if isAnyRole();
      allow create, update, delete: if isSuperAdmin();
    }

    // ============ ACADEMIC CONFIGS COLLECTION ============
    // Document ID = college ID
    // Fields: courses (nested map), updatedAt
    match /academic_configs/{collegeId} {
      // SuperAdmin: full CRUD
      // CollegeAdmin: read/update own college config
      // Trainer: read (needed for session form)
      allow read: if isAnyRole();
      allow create, delete: if isSuperAdmin();
      allow update: if isSuperAdmin() || (isCollegeAdmin() && getUserCollegeId() == collegeId);
    }

    // ============ PROJECT CODES COLLECTION ============
    // Fields: code, collegeId, course, year, batch, department, status, createdAt
    match /project_codes/{codeId} {
      // SuperAdmin: full CRUD
      // CollegeAdmin: read all (needed for session creation)
      // Trainer: read all (needed for session view)
      allow read: if isAnyRole();
      allow create, update, delete: if isSuperAdmin();
    }

    // ============ SESSIONS COLLECTION ============
    // Fields: collegeId, assignedTrainer, course, year, batch, domain, status, 
    //         sessionDate, sessionCode, compiledStats, questions, createdAt
    match /sessions/{sessionId} {
      // SuperAdmin: full CRUD
      // CollegeAdmin: read sessions for their college, create sessions for their college
      // Trainer: read sessions assigned to them
      // Public (unauthenticated): read active sessions (for feedback form via session code lookup)
      allow read: if true; // Public read needed for feedback form session lookup
      allow create: if isAdminOrAbove();
      allow update: if isAdminOrAbove() || isTrainer();
      allow delete: if isSuperAdmin();

      // ---- RESPONSES SUBCOLLECTION ----
      // Path: sessions/{sessionId}/responses/{responseId}
      // Fields: deviceId, answers, submittedAt
      match /responses/{responseId} {
        // Public: create responses (feedback submission - no auth required)
        // Authenticated users: read responses for analytics
        allow read: if isAnyRole();
        allow create: if true; // Public feedback submission
        allow update, delete: if isSuperAdmin();
      }
    }

    // ============ FEEDBACK TEMPLATES COLLECTION ============
    // Fields: name, questions, createdAt
    match /feedback_templates/{templateId} {
      // SuperAdmin: full CRUD
      // CollegeAdmin/Trainer: read only
      allow read: if isAnyRole();
      allow create, update, delete: if isSuperAdmin();
    }

    // ============ TICKETS COLLECTION ============
    // Fields: title, description, raisedBy, status, priority, createdAt, resolvedAt
    match /tickets/{ticketId} {
      // SuperAdmin: full CRUD (manage all tickets)
      // CollegeAdmin/Trainer: create own tickets, read own tickets
      allow read: if isSuperAdmin() || 
                     (isAuthenticated() && resource.data.raisedBy.uid == request.auth.uid);
      allow create: if isAnyRole();
      allow update: if isSuperAdmin() || 
                       (isAuthenticated() && resource.data.raisedBy.uid == request.auth.uid);
      allow delete: if isSuperAdmin();
    }

    // ============ COLLEGE CACHE COLLECTION ============
    // Document ID = college ID
    // Fields: totalSessions, totalResponses, ratingSum, totalRatingsCount,
    //         ratingDistribution, categoryData, domains, courses, qualitative, updatedAt
    match /collegeCache/{collegeId} {
      // Read: Any authenticated role
      // Write: System only (triggered by session close/delete via client code)
      //        SuperAdmin and CollegeAdmin need write for cache rebuild
      allow read: if isAnyRole();
      allow write: if isAdminOrAbove();

      // ---- TRENDS SUBCOLLECTION ----
      // Path: collegeCache/{collegeId}/trends/{yearMonth}
      match /trends/{yearMonth} {
        allow read: if isAnyRole();
        allow write: if isAdminOrAbove();
      }
    }

    // ============ TRAINER CACHE COLLECTION ============
    // Document ID = trainer UID
    // Fields: totalSessions, totalResponses, ratingSum, totalRatingsCount,
    //         ratingDistribution, categoryData, qualitative, updatedAt
    match /trainerCache/{trainerId} {
      // Read: SuperAdmin/CollegeAdmin read all, Trainer reads own
      // Write: System only (triggered by session close/delete)
      allow read: if isAdminOrAbove() || (isTrainer() && request.auth.uid == trainerId);
      allow write: if isAdminOrAbove();

      // ---- TRENDS SUBCOLLECTION ----
      // Path: trainerCache/{trainerId}/trends/{yearMonth}
      match /trends/{yearMonth} {
        allow read: if isAdminOrAbove() || (isTrainer() && request.auth.uid == trainerId);
        allow write: if isAdminOrAbove();
      }
    }

    // ============ DENY ALL OTHER COLLECTIONS ============
    // Explicit deny-all for any collection not defined above
    // (Firestore denies by default, but this makes it explicit)
  }
}